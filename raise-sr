#!/bin/bash

if [ -z "$1" ]; then
  echo "Usage: raise-sr \"Summary text\""
  exit 1
fi

OUTPUT=$(ansible-playbook -i localhost, /opt/jira-sr/create_sdimd_sr.yml \
  --ask-vault-pass \
  -e "{\"summary\":\"$1\"}" 2>&1)

STATUS=$?

if [ $STATUS -ne 0 ]; then
  echo "‚ùå Failed to raise Service Request"
  echo "$OUTPUT"
  exit 1
fi

ISSUE_KEY=$(echo "$OUTPUT" | grep -o 'ISSUE_KEY=[A-Z0-9-]\+' | cut -d= -f2)
ISSUE_URL=$(echo "$OUTPUT" | grep -o 'ISSUE_URL=https[^ ]\+')

if [ -n "$ISSUE_KEY" ]; then
  echo "‚úÖ Service Request raised: $ISSUE_KEY"
  [ -n "$ISSUE_URL" ] && echo "üîó $ISSUE_URL"
else
  echo "‚úÖ Service Request raised successfully"
fi

