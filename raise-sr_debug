#!/usr/bin/env bash
set -euo pipefail

PLAYBOOK="/opt/jira-sr/create_sdimd_sr.yml"

usage() {
  cat <<EOF
Usage:
  raise-sr "problem statement" [--env prod|nonprod] [--team unix|db|network|windows|mw|SD-###] [--assign-to USERNAME] [--desc "full description"]

Examples:
  raise-sr "Vision PROD LAN error"
  raise-sr "Issue" --env nonprod --team db --assign-to syed.shakeel
  raise-sr "Issue" --team SD-139 --assign-to prudhviraj.konidhina
EOF
}

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

SUMMARY=""
DESC=""
ENV=""
TEAM=""
ASSIGN_TO=""

# First arg: summary/problem statement (unless it starts with --)
if [[ "${1:-}" != --* ]]; then
  SUMMARY="$1"
  shift
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --env) ENV="${2:-}"; shift 2 ;;
    --team) TEAM="${2:-}"; shift 2 ;;
    --assign-to) ASSIGN_TO="${2:-}"; shift 2 ;;
    --desc|--description) DESC="${2:-}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *)
      echo "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

if [[ -z "${SUMMARY// /}" ]]; then
  echo "âŒ Missing problem statement."
  usage
  exit 1
fi

EXTRA_VARS=()
EXTRA_VARS+=("summary=$SUMMARY")

if [[ -n "${DESC// /}" ]]; then
  EXTRA_VARS+=("description=$DESC")
fi

# env -> option id
if [[ -n "${ENV// /}" ]]; then
  case "$ENV" in
    prod|production) EXTRA_VARS+=("sdimd_environment_id=20707") ;;
    nonprod|non-production|nonproduction) EXTRA_VARS+=("sdimd_environment_id=20708") ;;
    *)
      echo "âŒ Invalid --env '$ENV' (use prod|nonprod)"
      exit 1
      ;;
  esac
fi

# team -> objectKey SD-###
if [[ -n "${TEAM// /}" ]]; then
  case "$TEAM" in
    unix)    EXTRA_VARS+=("sdimd_team_object_key=SD-157") ;;
    db|database) EXTRA_VARS+=("sdimd_team_object_key=SD-139") ;;
    network) EXTRA_VARS+=("sdimd_team_object_key=SD-150") ;;
    windows) EXTRA_VARS+=("sdimd_team_object_key=SD-XXX") ;;  # replace when you know
    mw|middleware) EXTRA_VARS+=("sdimd_team_object_key=SD-XXX") ;;  # replace when you know
    SD-*)    EXTRA_VARS+=("sdimd_team_object_key=$TEAM") ;;
    *)
      echo "âŒ Invalid --team '$TEAM' (use unix|db|network|windows|mw|SD-###)"
      exit 1
      ;;
  esac
fi

# assignee override
if [[ -n "${ASSIGN_TO// /}" ]]; then
  EXTRA_VARS+=("assign_to=$ASSIGN_TO")
fi

ANSIBLE_ARGS=()
for kv in "${EXTRA_VARS[@]}"; do
  ANSIBLE_ARGS+=(-e "$kv")
done

# Run locally, no inventory needed
if ansible-playbook -i localhost, -c local "$PLAYBOOK" --ask-vault-pass "${ANSIBLE_ARGS[@]}" >/tmp/raise-sr.out 2>&1; then
  KEY="$(grep -oE 'Created issue: SDIMD-[0-9]+' /tmp/raise-sr.out | awk '{print $3}' | tail -n 1)"
  if [[ -n "${KEY:-}" ]]; then
    echo "âœ… Service Request raised successfully: $KEY"
    echo "ğŸ”— Agent : https://jira.emaratech.ae/browse/$KEY"
  else
    echo "âœ… Service Request raised successfully"
  fi
else
  cat /tmp/raise-sr.out
  echo
  echo "âŒ Failed to raise Service Request"
  exit 1
fi

